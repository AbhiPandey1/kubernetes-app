{"version":3,"sources":["../../../src/components/clusters/clusterConfig.js"],"names":["slugify","str","slug","replace","_","appEvents","angular","ClusterConfigCtrl","$scope","$injector","backendSrv","$q","contextSrv","$location","$window","alertSrv","self","isOrgEditor","hasRole","cluster","type","pageReady","snapDeployed","showHelp","getDatasources","then","promises","search","push","getCluster","getDaemonSets","forEach","ds","items","daemonSet","metadata","name","getGraphiteDatasources","all","id","get","jsonData","result","datasources","filter","request","url","method","headers","saveDatasource","set","catch","err","cm","generateConfigMap","saveToFile","filename","json","blob","Blob","toJson","wnd","window","saveAs","question","emit","title","text","yesText","icon","onConfirm","saveAndDeploy","undeploySnap","put","post","deploySnap","task","cloneDeep","snapTask","workflow","collect","publish","config","prefix","port","server","configMap","data","JSON","stringify","createConfigMap","createDaemonSet","updateSnapSettings","deleteConfigMap","deleteDaemonSet","deletePods","clusterId","pods","length","pod","history","back","templateUrl"],"mappings":"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","file":"clusterConfig.js","sourcesContent":["import _ from 'lodash';\nimport appEvents from 'app/core/app_events';\nimport angular from 'angular';\n\nfunction slugify(str) {\n  var slug = str.replace(\"@\", \"at\").replace(\"&\", \"and\").replace(/[.]/g, \"_\").replace(\"/\\W+/\", \"\");\n  return slug;\n}\n\nexport class ClusterConfigCtrl {\n  /** @ngInject */\n  constructor($scope, $injector, backendSrv, $q, contextSrv, $location, $window, alertSrv) {\n    var self = this;\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.isOrgEditor = contextSrv.hasRole('Editor') || contextSrv.hasRole('Admin');\n    this.$window = $window;\n    this.$location = $location;\n    this.cluster = {type: 'raintank-kubernetes-datasource'};\n    this.pageReady = false;\n    this.snapDeployed = false;\n    this.alertSrv = alertSrv;\n    this.showHelp = false;\n\n    this.getDatasources().then(() => {\n      self.pageReady = true;\n    });\n  }\n\n  toggleHelp() {\n    this.showHelp = !this.showHelp;\n  }\n\n  getDatasources() {\n    var self = this;\n    var promises = [];\n    if (\"cluster\" in self.$location.search()) {\n      promises.push(self.getCluster(this.$location.search().cluster).then(() => {\n        return self.getDaemonSets().then(ds => {\n          _.forEach(ds.items, function(daemonSet) {\n            if (daemonSet.metadata.name === \"snap\") {\n              self.snapDeployed = true;\n            }\n          });\n        });\n      }));\n    }\n\n    promises.push(self.getGraphiteDatasources());\n\n    return this.$q.all(promises);\n  }\n\n  getCluster(id) {\n    var self = this;\n    return this.backendSrv.get('/api/datasources/'+id)\n    .then((ds) => {\n      if (!(ds.jsonData.ds)) {\n        ds.jsonData.ds = \"\";\n      }\n      self.cluster = ds;\n    });\n  }\n\n  getGraphiteDatasources() {\n    var self = this;\n    return this.backendSrv.get('/api/datasources')\n    .then((result) => {\n      self.datasources = _.filter(result, {\"type\": \"graphite\"});\n    });\n  }\n\n  getDaemonSets() {\n    var self = this;\n    return this.backendSrv.request({\n      url: 'api/datasources/proxy/' + self.cluster.id + '/apis/extensions/v1beta1/daemonsets',\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    });\n  }\n\n  save() {\n    return this.saveDatasource()\n      .then(() => {\n        return this.getDatasources();\n      })\n      .then(() => {\n        this.alertSrv.set(\"Saved\", \"Saved and successfully connected to \" + this.cluster.name, 'success', 3000);\n      })\n      .catch(err => {\n        this.alertSrv.set(\"Saved\", \"Saved but failed to connect to \" + this.cluster.name + '. Error: ' + err, 'error', 5000);\n      });\n  }\n\n  saveConfigMapToFile() {\n    const cm = this.generateConfigMap();\n    this.saveToFile('snap-configmap', cm);\n  }\n\n  saveDaemonSetToFile() {\n    this.saveToFile('snap-daemonset', daemonSet);\n  }\n\n  saveToFile(filename, json) {\n    const blob = new Blob([angular.toJson(json, true)], { type: \"application/json;charset=utf-8\" });\n    const wnd = window;\n    wnd.saveAs(blob, filename + '.json');\n  }\n\n  deploy() {\n    var question = !this.snapDeployed ?\n      'This action will deploy a DaemonSet to your Kubernetes cluster. It uses Intel Snap to collect health metrics. '\n      + 'Are you sure you want to deploy?'\n      : 'This action will update the Config Map for the Snap DaemonSet and recreate the snapd pod on your Kubernetes cluster. '\n      + 'Are you sure you want to deploy?';\n    appEvents.emit('confirm-modal', {\n      title: 'Deploy to Kubernetes Cluster',\n      text: question,\n      yesText: \"Deploy\",\n      icon: \"fa-question\",\n      onConfirm: () => {\n        this.saveAndDeploy();\n      }\n    });\n  }\n\n  undeploy() {\n    var question = 'This action will remove the DaemonSet on your Kubernetes cluster that collects health metrics. '\n      + 'Are you sure you want to remove it?';\n\n    appEvents.emit('confirm-modal', {\n      title: 'Remove Daemonset Collector',\n      text: question,\n      yesText: \"Remove\",\n      icon: \"fa-question\",\n      onConfirm: () => {\n        this.undeploySnap();\n      }\n    });\n  }\n\n  saveDatasource() {\n    if (this.cluster.id) {\n      return this.backendSrv.put('/api/datasources/' + this.cluster.id, this.cluster);\n    } else {\n      return this.backendSrv.post('/api/datasources', this.cluster);\n    }\n  }\n\n  saveAndDeploy() {\n    return this.saveDatasource()\n      .then(() => {\n        return this.deploySnap();\n      });\n  }\n\n  generateConfigMap() {\n    var task = _.cloneDeep(snapTask);\n    task.workflow.collect.publish[0].config.prefix = \"snap.\"+slugify(this.cluster.name) + \".<%NODE%>\";\n    task.workflow.collect.publish[0].config.port = this.cluster.jsonData.port;\n    task.workflow.collect.publish[0].config.server = this.cluster.jsonData.server;\n    var cm = _.cloneDeep(configMap);\n    cm.data[\"core.json\"] = JSON.stringify(task);\n    return cm;\n  }\n\n  deploySnap() {\n    if(!this.cluster || !this.cluster.id) {\n      this.alertSrv.set(\"Error\", \"Could not connect to cluster.\", 'error');\n      return;\n    }\n\n    var self = this;\n    var cm = this.generateConfigMap();\n\n    if (!this.snapDeployed) {\n      return this.createConfigMap(self.cluster.id, cm)\n      .then(() => {\n        return this.createDaemonSet(self.cluster.id, daemonSet);\n      })\n      .catch(err => {\n        this.alertSrv.set(\"Error\", err, 'error');\n      }).then(() => {\n        this.snapDeployed = true;\n        this.alertSrv.set(\"Deployed\", \"Snap DaemonSet for Kubernetes metrics deployed to \" + self.cluster.name, 'success', 5000);\n      });\n    } else {\n      return self.updateSnapSettings(cm);\n    }\n  }\n\n  undeploySnap() {\n    var self = this;\n    return this.deleteConfigMap(self.cluster.id)\n      .then(() => {\n        return this.deleteDaemonSet(self.cluster.id);\n      })\n      .then(() => {\n        return this.deletePods();\n      })\n      .then(() => {\n        this.snapDeployed = false;\n        this.alertSrv.set(\"Daemonset removed\", \"Snap DaemonSet for Kubernetes metrics removed from \" + self.cluster.name, 'success', 5000);\n      });\n  }\n\n  createConfigMap(clusterId, cm) {\n    return this.backendSrv.request({\n      url: 'api/datasources/proxy/' + clusterId + '/api/v1/namespaces/kube-system/configmaps',\n      method: 'POST',\n      data: cm,\n      headers: { 'Content-Type': 'application/json' }\n    });\n  }\n\n  createDaemonSet(clusterId, daemonSet) {\n    return this.backendSrv.request({\n      url: 'api/datasources/proxy/' + clusterId + '/apis/extensions/v1beta1/namespaces/kube-system/daemonsets',\n      method: 'POST',\n      data: daemonSet,\n      headers: {'Content-Type': \"application/json\"}\n    });\n  }\n\n  deleteDaemonSet(clusterId) {\n    return this.backendSrv.request({\n      url: 'api/datasources/proxy/' + clusterId + '/apis/extensions/v1beta1/namespaces/kube-system/daemonsets/snap',\n      method: 'DELETE',\n    });\n  }\n\n  deleteConfigMap(clusterId) {\n    return this.backendSrv.request({\n      url: 'api/datasources/proxy/' + clusterId + '/api/v1/namespaces/kube-system/configmaps/snap-tasks',\n      method: 'DELETE'\n    });\n  }\n\n  deletePods() {\n    var self = this;\n    return this.backendSrv.request({\n      url: 'api/datasources/proxy/' + self.cluster.id + '/api/v1/namespaces/kube-system/pods?labelSelector=daemon%3Dsnapd',\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    }).then(pods => {\n      if (!pods || pods.items.length === 0) {\n        throw \"No snapd pod found to update.\";\n      }\n\n      var promises = [];\n\n      _.forEach(pods.items, pod => {\n        promises.push(this.backendSrv.request({\n          url: 'api/datasources/proxy/' + self.cluster.id + '/api/v1/namespaces/kube-system/pods/' + pod.metadata.name,\n          method: 'DELETE',\n        }));\n      });\n\n      return this.$q.all(promises);\n    });\n  }\n\n  updateSnapSettings(cm) {\n    var self = this;\n    return this.deleteConfigMap(self.cluster.id)\n    .then(() => {\n      return this.createConfigMap(self.cluster.id, cm);\n    }).then(() => {\n      return this.deletePods();\n    }).catch(err => {\n      this.alertSrv.set(\"Error\", err, 'error');\n    }).then(() => {\n      this.alertSrv.set(\"Updated\", \"Graphite Settings in Config Map on \" + self.cluster.name + \" updated successfully\", 'success', 3000);\n    });\n  }\n\n  cancel() {\n    this.$window.history.back();\n  }\n\n}\n\nClusterConfigCtrl.templateUrl = 'components/clusters/partials/cluster_config.html';\n\nvar configMap = {\n  \"kind\": \"ConfigMap\",\n  \"apiVersion\": \"v1\",\n  \"metadata\": {\n    \"name\": \"snap-tasks\",\n    \"namespace\": \"kube-system\"\n  },\n  \"data\": {\n    \"core.json\": \"\"\n  }\n};\n\nvar snapTask = {\n  \"version\": 1,\n  \"schedule\": {\n    \"type\": \"simple\",\n    \"interval\": \"10s\"\n  },\n  \"workflow\": {\n    \"collect\": {\n      \"metrics\": {\n        \"/intel/docker/*\":{},\n        \"/intel/procfs/cpu/*\": {},\n        \"/intel/procfs/meminfo/*\": {},\n        \"/intel/procfs/iface/*\": {},\n        \"/intel/linux/iostat/*\": {},\n        \"/intel/procfs/load/*\": {}\n      },\n      \"config\": {\n        \"/intel/procfs\": {\n          \"proc_path\": \"/proc_host\"\n        }\n      },\n      \"process\": null,\n      \"publish\": [\n        {\n          \"plugin_name\": \"graphite\",\n          \"config\": {\n            \"prefix\": \"\",\n            \"server\": \"\",\n            \"port\": 2003\n          }\n        }\n      ]\n    }\n  }\n};\n\nvar daemonSet = {\n  \"kind\": \"DaemonSet\",\n  \"apiVersion\": \"extensions/v1beta1\",\n  \"metadata\": {\n    \"name\": \"snap\",\n    \"namespace\": \"kube-system\",\n    \"labels\": {\n      \"daemon\": \"snapd\"\n    }\n  },\n  \"spec\": {\n    \"selector\": {\n      \"matchLabels\": {\n        \"daemon\": \"snapd\"\n      }\n    },\n    \"template\": {\n      \"metadata\": {\n        \"name\": \"snap\",\n        \"labels\": {\n          \"daemon\": \"snapd\"\n        }\n      },\n      \"spec\": {\n        \"volumes\": [\n          {\n            \"name\": \"dev\",\n            \"hostPath\": {\n              \"path\": \"/dev\"\n            }\n          },\n          {\n            \"name\": \"cgroup\",\n            \"hostPath\": {\n              \"path\": \"/sys/fs/cgroup\"\n            }\n          },\n          {\n            \"name\": \"docker-sock\",\n            \"hostPath\": {\n              \"path\": \"/var/run/docker.sock\"\n            }\n          },\n          {\n            \"name\": \"fs-stats\",\n            \"hostPath\": {\n              \"path\": \"/var/lib/docker\"\n            }\n          },\n          {\n            \"name\": \"docker\",\n            \"hostPath\": {\n              \"path\": \"/usr/bin/docker\"\n            }\n          },\n          {\n            \"name\": \"proc\",\n            \"hostPath\": {\n              \"path\": \"/proc\"\n            }\n          },\n          {\n            \"name\": \"snap-tasks\",\n            \"configMap\": {\n              \"name\": \"snap-tasks\"\n            }\n          }\n        ],\n        \"containers\": [\n          {\n            \"name\": \"snap\",\n            \"image\": \"raintank/snap_k8s:v13\",\n            \"ports\": [\n              {\n                \"name\": \"snap-api\",\n                \"hostPort\": 8181,\n                \"containerPort\": 8181,\n                \"protocol\": \"TCP\"\n              }\n            ],\n            \"env\": [\n              {\n                \"name\": \"PROCFS_MOUNT\",\n                \"value\": \"/proc_host\"\n              },\n              {\n                \"name\": \"NODE_NAME\",\n                \"valueFrom\": {\n                  \"fieldRef\": {\n                    \"fieldPath\": \"spec.nodeName\"\n                  }\n                }\n              }\n            ],\n            \"resources\": {},\n            \"volumeMounts\": [\n              {\n                \"name\": \"cgroup\",\n                \"mountPath\": \"/sys/fs/cgroup\"\n              },\n              {\n                \"name\": \"docker-sock\",\n                \"mountPath\": \"/var/run/docker.sock\"\n              },\n              {\n                \"name\": \"fs-stats\",\n                \"mountPath\": \"/var/lib/docker\"\n              },\n              {\n                \"name\": \"docker\",\n                \"mountPath\": \"/usr/local/bin/docker\"\n              },\n              {\n                \"name\": \"proc\",\n                \"mountPath\": \"/proc_host\"\n              },\n              {\n                \"name\": \"snap-tasks\",\n                \"mountPath\": \"/opt/snap/tasks\"\n              }\n            ],\n            \"imagePullPolicy\": \"IfNotPresent\",\n            \"securityContext\": {\n              \"privileged\": true\n            }\n          }\n        ],\n        \"restartPolicy\": \"Always\",\n        \"hostNetwork\": true,\n        \"hostPID\": true\n      }\n    }\n  }\n};\n"]}