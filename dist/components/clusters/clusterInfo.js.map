{"version":3,"sources":["../../../src/components/clusters/clusterInfo.js"],"names":["slugify","str","slug","replace","_","$","K8sClusterAPI","ClusterInfoCtrl","$scope","$injector","backendSrv","$q","$location","alertSrv","clusterAPI","pageReady","cluster","componentStatuses","namespaces","namespace","nodes","search","set","getCluster","then","id","getWorkloads","get","stats","items","ns","ds","component","health","forEach","conditions","condition","type","status","componentHealth","node","nodeStatus","evt","clickTargetIsLinkOrHasLinkParents","target","closest","length","path","jsonData","name","metadata","closestElm","head","clickTargetClickAttr","find","attributes","clickTargetIsNodeDashboard","value","templateUrl"],"mappings":"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","file":"clusterInfo.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport {K8sClusterAPI} from './k8sClusterAPI';\n\nfunction slugify(str) {\n  var slug = str.replace(\"@\", \"at\").replace(\"&\", \"and\").replace(\".\", \"_\").replace(\"/\\W+/\", \"\");\n  return slug;\n}\n\nexport class ClusterInfoCtrl {\n  /** @ngInject */\n  constructor($scope, $injector, backendSrv, $q, $location, alertSrv) {\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.$location = $location;\n    this.clusterAPI = {};\n\n    this.pageReady = false;\n    this.cluster = {};\n    this.componentStatuses = [];\n    this.namespaces = [];\n    this.namespace = \"\";\n    this.nodes = [];\n\n    if (!(\"cluster\" in $location.search())) {\n      alertSrv.set(\"no cluster specified.\", \"no cluster specified in url\", 'error');\n      return;\n    }\n\n    this.getCluster($location.search().cluster).then(() => {\n      this.clusterAPI = new K8sClusterAPI(this.cluster.id, backendSrv);\n      this.pageReady = true;\n      this.getWorkloads();\n    });\n  }\n\n  getWorkloads() {\n    this.clusterAPI.get('componentstatuses').then(stats => {\n      this.componentStatuses = stats.items;\n    });\n    this.clusterAPI.get('namespaces').then(ns => {\n      this.namespaces = ns.items;\n    });\n    this.clusterAPI.get('nodes').then(nodes => {\n      this.nodes = nodes.items;\n    });\n  }\n\n  getCluster(id) {\n    return this.backendSrv.get('api/datasources/'+id).then(ds => {\n      this.cluster = ds;\n    });\n  }\n\n  componentHealth(component) {\n    var health = \"unhealthy\";\n    _.forEach(component.conditions, function(condition) {\n      if ((condition.type === \"Healthy\") && (condition.status === \"True\")) {\n        health = \"healthy\";\n      }\n    });\n    return health;\n  }\n\n  isComponentHealthy(component) {\n    return this.componentHealth(component) === \"healthy\";\n  }\n\n  nodeStatus(node) {\n    var health = \"unhealthy\";\n    _.forEach(node.status.conditions, function(condition) {\n      if ((condition.type === \"Ready\") && (condition.status === \"True\")) {\n        health = \"healthy\";\n      }\n    });\n    return health;\n  }\n\n  isNodeHealthy(node) {\n    return this.nodeStatus(node) === \"healthy\";\n  }\n\n  goToNodeDashboard(node, evt) {\n    var clickTargetIsLinkOrHasLinkParents = $(evt.target).closest('a').length > 0;\n    if (clickTargetIsLinkOrHasLinkParents === false) {\n      this.$location.path(\"dashboard/db/kubernetes-node\")\n      .search({\n        \"var-datasource\": this.cluster.jsonData.ds,\n        \"var-cluster\": this.cluster.name,\n        \"var-node\": slugify(node.metadata.name)\n      });\n    }\n  }\n\n  goToWorkloads(ns, evt) {\n    var clickTargetIsLinkOrHasLinkParents = $(evt.target).closest('a').length > 0;\n    if (clickTargetIsLinkOrHasLinkParents === false) {\n      this.$location.path(\"plugins/raintank-kubernetes-app/page/cluster-workloads\")\n      .search({\n        \"cluster\": this.cluster.id,\n        \"namespace\": slugify(ns.metadata.name)\n      });\n    }\n  }\n\n  goToNodeInfo(node, evt) {\n    var clickTargetIsLinkOrHasLinkParents = $(evt.target).closest('a').length > 0;\n\n    var closestElm = _.head($(evt.target).closest('div'));\n    var clickTargetClickAttr = _.find(closestElm.attributes, {name: \"ng-click\"});\n    var clickTargetIsNodeDashboard = clickTargetClickAttr ? clickTargetClickAttr.value === \"ctrl.goToNodeDashboard(node, $event)\" : false;\n    if (clickTargetIsLinkOrHasLinkParents === false &&\n        clickTargetIsNodeDashboard === false) {\n      this.$location.path(\"plugins/raintank-kubernetes-app/page/node-info\")\n      .search({\n        \"cluster\": this.cluster.id,\n        \"node\": slugify(node.metadata.name)\n      });\n    }\n  }\n}\n\nClusterInfoCtrl.templateUrl = 'components/clusters/partials/cluster_info.html';\n"]}