{"version":3,"sources":["../../../src/panels/podNav/podNav.js"],"names":["PanelCtrl","_","panelDefaults","PodNavCtrl","$scope","$injector","backendSrv","datasourceSrv","$location","alertSrv","variableSrv","$q","defaults","panel","templateVariables","variables","namespace","currentTags","currentPods","selectedPods","setDefaults","loadTags","chosenTags","needsRefresh","cluster","find","ns","clusterName","current","value","getCluster","then","getPods","parseTagsFromPods","pods","uniq","map","p","metadata","name","search","set","podVariable","isArray","length","promises","forEach","push","clusterDS","all","flatten","filter","n","getPodsByName","pod","labels","label","includes","removeEmptyTags","getPodsByLabel","updateTemplateVariableWithPods","variable","text","join","isEmpty","updateOptions","variableUpdated","$emit","$root","$broadcast","omitBy","val","get","result","ds","jsonData","tag","podName","remove","templateUrl"],"mappings":"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","file":"podNav.js","sourcesContent":["import {PanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\n\nconst panelDefaults = {\n};\n\nexport class PodNavCtrl extends PanelCtrl {\n  constructor($scope, $injector, backendSrv, datasourceSrv, $location, alertSrv, variableSrv, $q) {\n    super($scope, $injector);\n    _.defaults(this.panel, panelDefaults);\n\n    this.backendSrv = backendSrv;\n    this.datasourceSrv = datasourceSrv;\n    this.$location = $location;\n    this.alertSrv = alertSrv;\n    this.variableSrv = variableSrv;\n    this.$q = $q;\n\n    this.templateVariables = this.variableSrv.variables;\n    this.namespace = \"All\";\n    this.currentTags = {};\n    this.currentPods = [];\n    this.selectedPods = [];\n\n    this.setDefaults();\n    this.loadTags();\n    this.chosenTags = {};\n  }\n\n  refresh() {\n    if (this.needsRefresh()) {\n      this.currentTags = {};\n      this.currentPods = [];\n      this.chosenTags = {};\n      this.selectedPods = [];\n\n      this.setDefaults();\n      this.loadTags();\n    }\n  }\n\n  needsRefresh() {\n    const cluster = _.find(this.templateVariables, {'name': 'cluster'});\n    const ns = _.find(this.templateVariables, {'name': 'namespace'});\n\n    if (this.clusterName !== cluster.current.value) { return true; }\n\n    if ((ns.current.value === '$__all' || ns.current.value[0] === '$__all')\n      && (this.namespace === ns.current.value || this.namespace === '')) {\n      return false;\n    }\n\n    if (ns.current.value !== this.namespace) { return true; }\n\n    return false;\n  }\n\n  loadTags() {\n    this.getCluster().then(() => {\n      return this.getPods().then(pods => {\n        this.parseTagsFromPods(pods);\n        this.currentPods = _.uniq(_.map(pods, p => { return p.metadata.name; }));\n      });\n    });\n  }\n\n  setDefaults() {\n    if (!(\"var-cluster\" in this.$location.search())) {\n      this.alertSrv.set(\"no cluster specified.\", \"no cluster specified in url\", 'error');\n      return;\n    }\n\n    const ns = _.find(this.templateVariables, {'name': 'namespace'});\n    this.namespace = ns.current.value !== '$__all' && ns.current.value[0] !== '$__all' ? ns.current.value : '';\n    const podVariable = _.find(this.templateVariables, {'name': 'pod'});\n\n    if (podVariable.current.value !== '$__all') {\n      this.selectedPods = _.isArray(podVariable.current.value) ? podVariable.current.value : [podVariable.current.value];\n    }\n  }\n\n  getPods() {\n    if (this.currentPods.length === 0) {\n      if (_.isArray(this.namespace)) {\n        const promises = [];\n        _.forEach(this.namespace, ns => {\n          promises.push(this.clusterDS.getPods(ns));\n        });\n        return this.$q.all(promises)\n        .then(pods => {\n          return _.flatten(pods).filter(n => n);\n        });\n      } else {\n        return this.clusterDS.getPods(this.namespace);\n      }\n    } else {\n      return this.clusterDS.getPodsByName(this.currentPods);\n    }\n  }\n\n  parseTagsFromPods(pods) {\n    this.currentTags = {};\n\n    _.forEach(pods, pod => {\n      _.forEach(pod.metadata.labels, (value, label) => {\n        if (!this.currentTags[label]) {\n          this.currentTags[label] = [];\n        }\n        if (!this.currentTags[label].includes(value)) {\n          this.currentTags[label].push(value);\n        }\n      });\n    });\n  }\n\n  onTagSelect() {\n    this.removeEmptyTags();\n    this.selectedPods = [];\n\n    this.getPodsByLabel()\n    .then(pods => {\n      this.currentPods = _.uniq(_.map(pods, p => { return p.metadata.name; }));\n      this.parseTagsFromPods(pods);\n      this.updateTemplateVariableWithPods();\n    });\n  }\n\n  getPodsByLabel() {\n    if (_.isArray(this.namespace)) {\n      const promises = [];\n      _.forEach(this.namespace, ns => {\n        promises.push(this.clusterDS.getPodsByLabel(ns, this.chosenTags));\n      });\n      return this.$q.all(promises)\n      .then(pods => {\n        return _.flatten(pods).filter(n => n);\n      });\n    } else {\n      return this.clusterDS.getPodsByLabel(this.namespace, this.chosenTags);\n    }\n  }\n\n  updateTemplateVariableWithPods() {\n    const variable = _.find(this.templateVariables, {'name': 'pod'});\n\n    if (this.selectedPods.length > 0) {\n      variable.current.text = this.selectedPods.join(' + ');\n      variable.current.value = this.selectedPods;\n    } else {\n      variable.current.text = _.isEmpty(this.chosenTags) ? 'All': this.currentPods.join(' + ');\n      variable.current.value = _.isEmpty(this.chosenTags) ? '$__all': this.currentPods;\n    }\n\n    this.variableSrv.updateOptions(variable).then(() => {\n      this.variableSrv.variableUpdated(variable).then(() => {\n        this.$scope.$emit('template-variable-value-updated');\n        this.$scope.$root.$broadcast('refresh');\n      });\n    });\n  }\n\n  removeEmptyTags() {\n    this.chosenTags = _.omitBy(this.chosenTags, val => { return !val;});\n  }\n\n  getCluster() {\n    const clusterName = this.$location.search()['var-cluster'];\n    this.clusterName = clusterName;\n\n    return this.backendSrv.get('/api/datasources')\n    .then(result => {\n      return _.filter(result, {\"name\": clusterName})[0];\n    })\n    .then((ds) => {\n      if (!(ds.jsonData.ds)) {\n        ds.jsonData.ds = \"\";\n      }\n      return this.datasourceSrv.get(ds.name);\n    }).then(clusterDS => {\n      this.clusterDS = clusterDS;\n    });\n  }\n\n  removeTag(tag) {\n    delete this.chosenTags[tag];\n    this.getPodsByLabel()\n    .then(pods => {\n      this.currentPods = _.uniq(_.map(pods, p => { return p.metadata.name; }));\n      this.parseTagsFromPods(pods);\n      this.updateTemplateVariableWithPods();\n    });\n  }\n\n  selectPod(podName) {\n    this.chosenTags = {};\n\n    if (!this.selectedPods.includes(podName)) {\n      this.selectedPods.push(podName);\n    }\n\n    this.updateTemplateVariableWithPods();\n  }\n\n  removePodTag(podName) {\n    _.remove(this.selectedPods, p => { return p === podName;});\n    this.updateTemplateVariableWithPods();\n\n    if (this.selectedPods.length === 0) {\n      this.currentPods = [];\n      this.loadTags();\n    }\n  }\n}\n\nPodNavCtrl.templateUrl = 'panels/podNav/partials/pod_nav.html';\n"]}